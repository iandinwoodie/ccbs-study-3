---
title: "Building Tidy Data"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo=TRUE)
```

# Overview

This notebook serves as reference for the tidying procedures used to prepare the
study data for analysis.

# Forming the Data Frame

## Loading the Raw Data

Load and verify the raw owner data.

```{r}
df_owners <- read.csv('../data/raw-owners.csv', header=TRUE, skipNul=TRUE)
names(df_owners)[names(df_owners) == 'What.is.your.email.'] <- 'owner_id'
stopifnot(identical(dim(df_owners)+0, c(717, 6)))
str(df_owners)
```

Load and verify the raw dog data.

```{r}
df_dogs <- read.csv('../data/raw-dogs.csv', header=TRUE, skipNul=TRUE)
names(df_dogs)[names(df_dogs) == 'id'] <- 'owner_id'
stopifnot(identical(dim(df_dogs)+0, c(969, 45)))
str(df_dogs[, c(1:3, 43:45)])
```

## Forming Complete Responses

```{r}
# Merge the raw owners and dogs data on the owner id.
df <- merge(df_owners, df_dogs, by='owner_id', all=TRUE)
stopifnot(identical(dim(df)+0, c(1181, 50)))
str(df[, c(1:3, 47:50)])
```

## Applying Readable Column Names

```{r}
colnames(df) <- readr::read_lines('../docs/readable-column-names.csv')
str(df)
```

# Dropping Unnecessary Columns

We use the following section to drop unnecessary columns from the data frame.

```{r}
df <- df %>%
  select(-(owner_referral_source:owner_token)) %>%
  select(-(owner_has_another_dog_to_enter:dog_token))
stopifnot(identical(dim(df)+0, c(1181, 41)))
str(df)
```

# Adjusting Data Types

We use the following sections to adjust field types in the data frame.

```{r}

#copy data frame
df_adj_dtypes <- df

# replace blank fields with "NA" ( = no answer / missing values)
#df_adj_dtypes[df_adj_dtypes==""] <- NA

# change comma-separated lists into separate columns

# separate each answer into its own column.

#dog_adolescent_or_adult_training_trainer
df_adj_dtypes <- df_adj_dtypes %>%
  mutate(trainer_group_classes = as.factor(ifelse(
    dog_adolescent_or_adult_training_trainer == "" | 
      dog_adolescent_or_adult_training_trainer == "I don't know", NA, ifelse(
      grepl('Myself/family member attended group classes', 
            dog_adolescent_or_adult_training_trainer), TRUE, FALSE)))) %>%
  mutate(trainer_boot_camp = as.factor(ifelse(
    dog_adolescent_or_adult_training_trainer == "" | 
      dog_adolescent_or_adult_training_trainer == "I don't know", NA, ifelse(
      grepl('Sent to professional training school/boot camp', 
            dog_adolescent_or_adult_training_trainer), TRUE, FALSE)))) %>%
  mutate(trainer_home_private = as.factor(ifelse(
    dog_adolescent_or_adult_training_trainer == "" | 
      dog_adolescent_or_adult_training_trainer == "I don't know", NA, ifelse(
      grepl('Hired in home private trainer', dog_adolescent_or_adult_training_trainer), TRUE, FALSE))))


#dog_adolescent_or_adult_training_completion_age
df_adj_dtypes <- df_adj_dtypes %>%
  mutate(training_complete_age_6_to_18mo = as.factor(ifelse(
    dog_adolescent_or_adult_training_completion_age == "" | 
      dog_adolescent_or_adult_training_completion_age == "I don't know", NA, ifelse(
      grepl('6 to 18 months \\(adolescence)', 
            dog_adolescent_or_adult_training_completion_age), TRUE, FALSE)))) %>%
  mutate(training_complete_age_18_to_36mo = as.factor(ifelse(
    dog_adolescent_or_adult_training_completion_age == "" | 
      dog_adolescent_or_adult_training_completion_age == "I don't know", NA, ifelse(
      grepl('18-36 months \\(social maturity)', 
            dog_adolescent_or_adult_training_completion_age), TRUE, FALSE)))) %>%
  mutate(training_complete_age_continue_in_home = as.factor(ifelse(
    dog_adolescent_or_adult_training_completion_age == "" | 
      dog_adolescent_or_adult_training_completion_age == "I don't know", NA, ifelse(
      grepl('Continue to practice and use training skills in home',
            dog_adolescent_or_adult_training_completion_age), TRUE, FALSE)))) %>%
  mutate(training_complete_age_continue_classes = as.factor(ifelse(
    dog_adolescent_or_adult_training_completion_age == "" | 
      dog_adolescent_or_adult_training_completion_age == "I don't know", NA, ifelse(
      grepl('Continue to attend classes periodically \\(nose work, agility, trick training, etc\\.)',
            dog_adolescent_or_adult_training_completion_age), TRUE, FALSE))))
  

#dog_agression_scenario
df_adj_dtypes <- df_adj_dtypes %>%
  mutate(aggression_strange_people_in_home = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Strangers visiting the home', 
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_strange_people_away_from_home = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Strangers away from the home', 
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_familiar_people_in_home = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Familiar people in the home',
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_familiar_people_away_from_home = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Familiar people away from the home',
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_strange_dog_in_home = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Unfamiliar dogs in the home', 
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_strange_dog_away_from_home = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Unfamiliar dogs away from the home', 
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_familiar_dog_in_home = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Familiar dogs in the home',
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_familiar_dog_away_from_home = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Familiar dogs away from the home',
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_vet = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Veterinarians',
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_other_animals = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Animals other than dogs',
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_groomer = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Groomers',
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_resource_guard = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Resource',
            dog_aggression_scenario), TRUE, FALSE)))) %>%
  mutate(aggression_trainer = as.factor(ifelse(
    dog_aggression_scenario == "" | 
      dog_aggression_scenario == "I don't know", NA, ifelse(
      grepl('Trainers',
            dog_aggression_scenario), TRUE, FALSE))))

# need 'other' category


#dog_fear_anxiety_scenario
df_adj_dtypes <- df_adj_dtypes %>%
  mutate(fear_anxiety_crowds = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Fear of crowds', 
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_vet = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Fear of veterinary visits', 
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_thunderstorms = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Fear of thunderstorms',
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_other_dogs = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Fear of other dogs',
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_noises = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Fear of noises', 
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_other_animals = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Fear of animals other than dogs', 
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_ = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Familiar dogs in the home',
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_ = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Familiar dogs away from the home',
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_ = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Veterinarians',
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_ = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Animals other than dogs',
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_ = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Groomers',
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_ = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Resource',
            dog_fear_anxiety_scenario), TRUE, FALSE)))) %>%
  mutate(fear_anxiety_ = as.factor(ifelse(
    dog_fear_anxiety_scenario == "" | 
      dog_fear_anxiety_scenario == "I don't know", NA, ifelse(
      grepl('Trainers',
            dog_fear_anxiety_scenario), TRUE, FALSE))))

  
  


# convert character-type columns to factors


```

# Additional Data Cleaning

We use the following sections to carry out additional tidying procedures.

```{r}
# TODO
```

# Final Summary

Take a last look at the data before saving it to disk.

```{r}
dim(df)
summary(df)
```

# Saving the Tidy Data

Save the data to a file in the data directory using RDS format so that the data
types are stored and the resulting file is compressed.

```{r}
saveRDS(df, '../data/tidy.Rds')
```
