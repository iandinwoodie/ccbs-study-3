---
title: "Exploratory Data Analysis"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggpubr)
library(GGally)
knitr::opts_chunk$set(echo=TRUE)
```

# Overview

This notebook catalogs the exploratory data analysis undertaken for this
project.

# Loading the Data

Load the tidy data set into memory. If it does not exist, then run the notebook
that builds it.

```{r}
tidy_data_filepath <- '../data/tidy.Rds'
if (!file.exists(tidy_data_filepath)) {
  rmarkdown::render('./notebook-0-tidy.Rmd')
}
df <- readRDS(tidy_data_filepath)
stopifnot(identical(dim(df)+0, c(1181, 104)))
str(df)
```
## Overview of Data Set

# summarize data

```{r}
summary(df)

```

```{r}
# Number of unique owners after inclusion criteria.
length(unique(df$owner_id))

```

```{r}
#number of dogs per household.
summary(plyr::count(df, 'owner_id'))
```
Median number of dogs per household = 1 (range: 1 to 21), mean 1.9. Now we can
drop the column to simply the data set.

```{r}
df <- subset(df, select=-c(owner_id))
```

Before we look at the data, let's add a basic behavior problem indicator column.

#how may dogs have any behavior issue? 

```{r}

df <- df %>%
  mutate(behav_problem = ifelse(
    dog_was_aggressive | dog_has_fear_or_anxiety | dog_has_jumped_problematically | 
      dog_has_barked_excessively | dog_has_coprophagia | dog_has_repetitive_behavior |
      dog_has_house_soiled | dog_has_rolled_in_repulsive_material | dog_was_hyperactive | 
      dog_was_destructive | dog_has_escaped | dog_has_mounted, TRUE, FALSE))
summary(df$behav_problem)
```

# general notes on dataset: (all stats exclude no answer or NA's)
-- 749 out of 1152 or 65.0% reported at least one behavior problem
-- Male/female spilt almost even (579 F, 573 M)
-- Mean age (in months) is 67 (5.6 years) and median age is 60 (5 years)
-- a majority of respondents (719/1152 = 62.4%) did NOT acquire their dog in the pre-adolescent stage
-- of the respondents who provided an answer (631), just under half of dogs had attended pre-adolescent training (295/631 = 46.8%). The majority of these dogs (239/295 = 81.0%) had received reward-based training only. A further 14.6% (43/295) received a mix of reward and discipline-based training. The vast majority (256/295 = 86.8%) attended group classes (as opposed to private training or boot camp).
-- of the respondents who provided an answer (773), more than half of dogs had attended adolescent or adult training (596/773 = 65.5%). Again the majority (410/506 = 81.0%) received reward-based training only through group classes (382/410 = 93.2%)
-- of the respondents that reported at least one behavioral problem, slight more than half (53.5% or 321 out of 600) had NOT undergone pre-adolescent training. However, more than half (65.3% or 489 out of 749) had undergone adolescent or adult training. 
-- the majority continued some form of training post-puppyhood: 13% (87/675) completed in adolescence, 13% (86/675) completed once the dog had reached adulthood, 46% (313/675) continue to train in-home, and 38% (256/675) continue to attend classes, with 62% (419/675) reporting some kind of continued training 

#specific behavior problems:
-- 37.3% reported aggression (430/1152)
-- 49.1% reported fear or anxiety (566/1152)
-- 13.1% reported problematic jumping (151/1152)
-- 12.4% reported excessive barking (143/1152)
-- 28.6% reported coprophagia (330/1152)
-- 17.7% reported repetitive behavior (204/1152)
-- 15.8% reported house soiling (182/1152)
-- 27.2% reported rolling in repulsive material (313/1152)
-- 8.0% reported hyperactivity (92/1152)
-- 10.4% reported destructive behavior (120/1152)


# make some plots

```{r}

# how many of dogs with behavior problems have had pre-adolescent training?

ggplot(df, aes(x = dog_attended_pre_adolescent_training)) +
  geom_bar() +
    geom_text(aes(label=..count..),stat='count',vjust=-0.2)

ggplot(df, aes(x = behav_problem)) +
  geom_bar() + geom_text(aes(label=..count..),stat='count',vjust=-0.2)

ggplot(data = df) +  
       geom_count(mapping = aes(x = dog_attended_pre_adolescent_training, y = behav_problem)) 

#df %>% 
  # create a column called n for number of times x & y occur together
  #count(dog_attended_pre_adolescent_training, behav_problem) %>% 
  # create columns for each unique value of y and 
  # put the values of column n below
  #spread(key = behav_problem, value = n, fill = 0) 

df %>% 
  count(dog_attended_pre_adolescent_training, behav_problem) %>%  
  ggplot(mapping = aes(x = dog_attended_pre_adolescent_training, y = behav_problem)) +
    geom_tile(mapping = aes(fill = n))

```


```{r}
ggplot(df, aes(x = dog_adolescent_or_adult_training)) +
  geom_bar() + geom_text(aes(label=..count..),stat='count',vjust=-0.2)

ggplot(data = df) +  
       geom_count(mapping = aes(x = dog_adolescent_or_adult_training, y = behav_problem)) 

df %>% 
  # create a column called n for number of times x & y occur together
  count(dog_adolescent_or_adult_training, behav_problem) %>% 
  # create columns for each unique value of y and 
  # put the values of column n below
  spread(key = behav_problem, value = n, fill = 0) 

df %>% 
  count(dog_adolescent_or_adult_training, behav_problem) %>%  
  ggplot(mapping = aes(x = dog_adolescent_or_adult_training, y = behav_problem)) +
    geom_tile(mapping = aes(fill = n))

```
# of the owners/dogs that reported any behavioral problems,

# slightly more than half (53.5% or 321 out of 600) had NOT attended pre-adolescent training
# more than half (65.3% or 489 out of 749) had attended adolescent or adult training

# there is likely an association between dogs with behavior issues and attending adolescent / adult training i.e. owners with dogs that have issues are more likely to sign up for additional training



```{r}

# examine variable distribution for all variables

ggplot(data = df) +
  geom_bar(mapping = aes(x = owner_age))

ggplot(data = df) +
  geom_bar(mapping = aes(x = dog_age_in_months))


```
```{r}
ggplot(df, aes(dog_age_in_months)) + geom_bar(fill='steelblue')
skewness(df$dog_age_in_months,na.rm=TRUE)

ggplot(df, aes(owner_age)) + geom_bar(fill='steelblue')
skewness(df$owner_age,na.rm=TRUE)

```

We see a right skew in the dog age plot, and a left skew in the owner age plot. Let's try to center it by applying a log transform.

```{r}
df <- df %>%
  mutate(log_dog_age = log(dog_age_in_months))
ggplot(df, aes(log_dog_age)) + geom_bar(fill='steelblue')
skewness(df$log_dog_age,na.rm=TRUE)


df <- df %>%
  mutate(log_owner_age = log(owner_age))
ggplot(df, aes(log_owner_age)) + geom_bar(fill='steelblue')
skewness(df$log_owner_age,na.rm=TRUE)

df <- subset(df, select=-c(log_dog_age))
df <- subset(df, select=-c(log_owner_age))


```
not helpful-- skews in the opposite direction with log transform

```{r}

#two categorical variables
ggplot(data = df) +  
       geom_count(mapping = aes(x = dog_attended_pre_adolescent_training, y = behav_problem))

ggplot(data = df) +  
       geom_count(mapping = aes(x = dog_adolescent_or_adult_training, y = behav_problem))
```

We create pairwise scatter plots for columns that all participants were
presented (i.e., no NA responses) and we exclude the individual behavior problem
columns for brevity.

```{r, fig.height=5, fig.width=5}
df %>%
  ggpairs(columns=c('dog_attended_pre_adolescent_training', 'dog_adolescent_or_adult_training', 
                    'dog_gender'),
          mapping=ggplot2::aes(color=behav_problem),
          diag=list(discrete='barDiag',
                    continuous=wrap('densityDiag', alpha=0.5)),
          legend=1,
          progress=FALSE) +
  theme(legend.position='bottom')
```

control group: those who had pre-adolescent training but no further training
treatment group: those with pre-adolescent training and adolescent and/or adult training

```{r}
df_control <- subset(df, dog_attended_pre_adolescent_training==TRUE & dog_adolescent_or_adult_training==FALSE)
df_exp <- subset(df, dog_attended_pre_adolescent_training==TRUE & dog_adolescent_or_adult_training==TRUE)
df_adult_only <- subset(df, dog_attended_pre_adolescent_training==FALSE & dog_adolescent_or_adult_training==TRUE)
df_no_training <- subset(df, dog_attended_pre_adolescent_training==FALSE & dog_adolescent_or_adult_training==FALSE)

nrow(df_control) + nrow(df_exp) + nrow(df_adult_only) + nrow(df_no_training)

df_continue_training <- subset(df, training_complete_age_continue_in_home==TRUE | training_complete_age_continue_classes==TRUE)


```

Of the 1181 total survey responses, 559 need to be excluded because they did not answer whether the dog had received pre-adolescent training and/or adult training. This leaves 622 responses. The breakdown of the group:

193 had no training (neither pre-adolescent or adult)
40 had pre-adolescent but no further training
254 had pre-adolescent and adult training
135 had no pre-adolescent training but did have adult training

```{r}
# how many of dogs with behavior problems have had pre-adolescent training but no further training?
ggplot(df_control, aes(x = behav_problem)) +
  geom_bar() + geom_text(aes(label=..count..),stat='count',vjust=-0.2)

# how many of dogs with behavior problems have had pre-adolescent training and further training?
ggplot(df_exp, aes(x = behav_problem)) +
  geom_bar() + geom_text(aes(label=..count..),stat='count',vjust=-0.2)

# how many of dogs with behavior problems have had no training?
ggplot(df_no_training, aes(x = behav_problem)) +
  geom_bar() + geom_text(aes(label=..count..),stat='count',vjust=-0.2)

# how many of dogs with behavior problems have had padult training only?
ggplot(df_adult_only, aes(x = behav_problem)) +
  geom_bar() + geom_text(aes(label=..count..),stat='count',vjust=-0.2)

```


```{r, fig.height=5, fig.width=5}
df %>%
  ggpairs(columns=c('dog_attended_pre_adolescent_training', 'dog_adolescent_or_adult_training', 
                    'dog_gender','dog_was_acquired_pre_adolescent', 'dog_age_in_months', 
                    'owner_gender'),
          mapping=ggplot2::aes(color=behav_problem),
          diag=list(discrete='barDiag',
                    continuous=wrap('densityDiag', alpha=0.5)),
          legend=1,
          progress=FALSE) +
  theme(legend.position='bottom')
```

Create column indicating whether the dog had any type of training (preadolescent or adult)

```{r}

df <- df %>%
  mutate(any_training = ifelse(
    dog_attended_pre_adolescent_training | dog_adolescent_or_adult_training, TRUE, FALSE))
summary(df$any_training)
```

How many dogs have behaviour problems with no vs. some training?

```{r}

ggplot(data = df) +  
       geom_count(mapping = aes(x = any_training, y = behav_problem))

```

```{r}
nrow(df[df$any_training == TRUE & df$behav_problem == FALSE, ])


```

```{r, fig.height=5, fig.width=5}
df %>%
  ggpairs(columns=c('any_training', 'dog_adolescent_or_adult_training', 
                    'dog_attended_pre_adolescent_training'),
          mapping=ggplot2::aes(color=behav_problem),
          diag=list(discrete='barDiag',
                    continuous=wrap('densityDiag', alpha=0.5)),
          legend=1,
          progress=FALSE) +
  theme(legend.position='bottom')

```

## Discrete Variables

### Independent Variables

```{r, fig.height=5, fig.width=5}
vars <- c(
  'any_training',
  'dog_was_acquired_pre_adolescent',
  'dog_attended_pre_adolescent_training',
  'dog_adolescent_or_adult_training',
  'dog_gender',
  'trainer_group_classes',
  'trainer_boot_camp',
  'trainer_home_private',
  'training_complete_age_6_to_18mo',
  'training_complete_age_18_to_36mo',
  'training_complete_age_continue_in_home',
  'training_complete_age_continue_classes'
)

plot_list <- list()
for (i in 1:length(vars)) {
  col <- vars[i]
  p <- df %>%
    select(col) %>%
    drop_na(col) %>%
    ggplot(aes_string(x = col)) +
    geom_bar(fill='steelblue')
  plot_list[[i]] <- p
}
ggarrange(plotlist=plot_list, ncol=3, nrow=4)
```


### Dependent Variables

```{r, fig.height=4, fig.width=5}
outcomes <- c(
  'dog_was_aggressive',
  'dog_has_fear_or_anxiety',
  'dog_has_jumped_problematically',
  'dog_has_barked_excessively',
  'dog_has_coprophagia',
  'dog_has_repetitive_behavior',
  'dog_has_house_soiled',
  'dog_has_rolled_in_repulsive_material',
  'dog_was_hyperactive',
  'dog_was_destructive',
  'dog_has_escaped',
  'dog_has_mounted'
)

plot_list <- list()
for (i in 1:length(outcomes)) {
  col <- outcomes[i]
  p <- df %>%
    select(col) %>%
    drop_na(col) %>%
    ggplot(aes_string(x = col)) +
    geom_bar(fill='steelblue')
  plot_list[[i]] <- p
}
ggarrange(plotlist=plot_list, ncol=4, nrow=3)
```
## Control vs Experimental Group

Our control group consists of the dogs who attended puppy training but no further training and our
experimental group consists of those who attended both puppy and adolescent/adult training.
Let's look at the variables common to both groups with the plot color indicating the presence of a behavior
problem. Since we know a vast majority of dogs have at least one behavior
problem, we need to look for trends in individual behavior problems for the
plots to be useful. 

```{r, fig.height=10, fig.width=5}
# Generate plots for each attribute split by a simple predictor.
pred <- 'any_training'
attribs <- c(
  'dog_was_acquired_pre_adolescent',
  'dog_age_in_months',
  'dog_gender'
)
attribs <- sort(attribs)
outcomes <- sort(outcomes)

plot_list <- list()
cnt <- 1
labels <- NULL
for (i in 1:length(outcomes)) {
  outcome <- outcomes[i]
  for (j in 1:length(attribs)) {
    attrib <- attribs[j]
    p <- df %>%
      drop_na(attrib) %>%
      select(attrib, outcome, pred) %>%
      ggplot(aes_string(x=attrib, fill=pred)) +
      geom_bar(position = position_dodge(0.9)) +
      labs(fill=pred) +
      theme(legend.position='none') +
      facet_grid(as.formula(paste0('.~', outcome)))
    plot_list[[cnt]] <- p
    cnt <- cnt + 1
    labels <- c(labels, outcome)
  }
}
ggarrange(plotlist=plot_list, ncol=4, nrow=12, common.legend=TRUE,
          font.label=list(size=10), vjust=0.75, legend='bottom', labels=labels)
```
## Within the Experimental Group

Within the experimental group we are curious to see the impact of various
training techniques on behavior problem occurrence. We
start by isolating the experimental group.

```{r}
summary(df_control)
```

```{r}
summary(df_exp)
```
Now we look at the impact of training age and frequency.

```{r, fig.height=10, fig.width=5}
attribs <- c(
  'dog_attended_pre_adolescent_training',
  'dog_adolescent_or_adult_training'
)
attribs <- sort(attribs)

plot_list <- list()
cnt <- 1
labels <- NULL
for (i in 1:length(outcomes)) {
  outcome <- outcomes[i]
  for (j in 1:length(attribs)) {
    attrib <- attribs[j]
    p <- df %>%
      drop_na(attrib) %>%
      select(attrib, outcome) %>%
      ggplot(aes_string(x=attrib, fill=outcome)) +
      geom_bar(position = position_dodge(0.9)) +
      labs(fill='has this behavior problem') +
      theme(legend.position='none')
    plot_list[[cnt]] <- p
    cnt <- cnt + 1
    labels <- c(labels, outcome)
  }
}
ggarrange(plotlist=plot_list, ncol=5, nrow=12, common.legend=TRUE,
          font.label=list(size=10), vjust=0.75, legend='bottom', labels=labels)
```
Next, we try to visual the impact (if any) of type of training

```{r, fig.height=10, fig.width=5}
attribs <- c(
  'device_used',
  'buckle_collar',
  'harness',
  'head_halter'
)

plot_list <- list()
cnt <- 1
labels <- NULL
for (i in 1:length(outcomes)) {
  outcome <- outcomes[i]
  for (j in 1:length(attribs)) {
    attrib <- attribs[j]
    p <- df %>%
      drop_na(attrib) %>%
      select(attrib, outcome) %>%
      ggplot(aes_string(x=attrib, fill=outcome)) +
      geom_bar(position = position_dodge(0.9)) +
      labs(fill='has this behavoior problem') +
      theme(legend.position='none')
    plot_list[[cnt]] <- p
    cnt <- cnt + 1
    labels <- c(labels, outcome)
  }
}
ggarrange(plotlist=plot_list, ncol=4, nrow=12, common.legend=TRUE,
          font.label=list(size=10), vjust=0.75, legend='bottom', labels=labels)
```

```{r}


```