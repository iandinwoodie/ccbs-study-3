---
title: "Model Check Example"
author: "Ian Dinwoodie"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(tidymodels)
#library(MASS)
library(caret)
library(car)
library(performance)

knitr::opts_chunk$set(echo=TRUE)
set.seed(1)
```

```{r}
# Create df here.
```

Check for near-zero variance variables.

```{r}
(nzv_metrics <- caret::nearZeroVar(df, saveMetrics=TRUE))
nzv_cnt <- sum(nzv_metrics$nzv)
print(paste("Warning:", nzv_cnt, "near-zero variance vars. found"))
if (nzv_cnt) {
  print(colnames(df[, nzv_metrics$nzv]))
}
```

Check for linearly correlated predictors.

```{r}
combo_info <- caret::findLinearCombos(df %>% dplyr::select(-outcome))
combo_cnt <- length(combo_info$remove)
print(paste("Linearly corr. combos vars to examine:", combo_cnt))
print(paste("Warning:", combo_cnt, "linearly corr. combos vars. found"))
if (combo_cnt) {
  print(colnames(df)[combo_info$remove])
}
```

# Models

## Null Model

```{r}
glm_fit_null <- glm(outcome~1, df, family="binomial")
summary(glm_fit_null)

(r2_null <- performance::r2_nagelkerke(glm_fit_null))
```

## Background Variables

```{r}
# Create df_back here.
```

```{r}
set.seed(1)
glm_fit_back <- glm(outcome ~ ., df_back, family="binomial")
summary(glm_fit_back)

get_performance_metrics <- function(fit, r2_prev) {
  r2_curr = performance::r2_nagelkerke(fit)
  print(r2_curr)
  print(paste("Delta R^2:", r2_curr-r2_prev))
  print(performance::performance_hosmer(fit))
  return(r2_curr)
}

r2_back <- get_performance_metrics(glm_fit_back, r2_null)
```

```{r}
(vif(glm_fit_back))
```

```{r}
bs_table <- function(fit, data) {
  df_results <- broom::tidy(fit, conf.int=TRUE, exponentiate=TRUE)
  
  glm_est <- function(split, ...) {
    glm(fit$formula, data = rsample::analysis(split), family="binomial") %>%
      tidy()
  }
  
  set.seed(1)
  conf_ints <- rsample::bootstraps(data, 10000, apparent = TRUE) %>%
    dplyr::mutate(results = map(splits, glm_est)) %>%
    rsample::int_bca(results, .fn = glm_est) %>%
    dplyr::mutate_at(c(".estimate", ".lower", ".upper"), ~ exp(.)) %>%
    dplyr::select(term, .lower, .upper) %>%
    dplyr::rename(bs.low=.lower, bs.high=.upper)
  
  df_results <- merge(df_results, conf_ints, by="term")
  df_results$p.value <- p.adjust(df_results$p.value, method='fdr')
  df_results$sig <- ''
  df_results[df_results$p.value <= .05, 'sig'] <- '*'
  df_results[df_results$p.value <= .01, 'sig'] <- '**'
  df_results[df_results$p.value <= .001, 'sig'] <- '***'
  for (i in 1:nrow(df_results)) {
    if (is.na(df_results[i, 'bs.low']) | is.na(df_results[i, 'bs.high'])) next
    if ((df_results[i, 'bs.low'] <= 1) & (df_results[i, 'bs.high'] >= 1)) {
      df_results[i, 'sig'] <- ''
    }
  }
  df_results <- df_results %>%
    dplyr::mutate(dplyr::across(where(is.numeric), round, 3))
  return(knitr::kable(df_results))
}

bs_table(glm_fit_back, df_back)
```

```{r}
anova(glm_fit_null, glm_fit_back, test="LRT")
```

## Adoption Source

```{r}
# Create df_source here.
```

```{r}
set.seed(1)
glm_fit_source <- glm(outcome ~ ., df_source, family="binomial")
summary(glm_fit_source)

r2_source <- get_performance_metrics(glm_fit_source, r2_back)
```

```{r}
(vif(glm_fit_source))
```

```{r}
bs_table(glm_fit_source, df_source)
```

```{r}
anova(glm_fit_back, glm_fit_source, test="LRT")
```

# Save Session Info

```{r}
sessionInfo()
```

